#!/bin/sh

# Run the spell checker, linter, and test suite on every commit. The working
# directory of this script will be the top level of the Git repository.


# Exit on error, stopping the commit.
set -e


# Wrap calls to run checks in container.
sif="$HOME/l/sif/pytorch_2.6.0-cuda12.6-cudnn9-runtime.sif"
env() { app_exec.sh "$sif" "$@" ; }


# Identify relevant files.
staged=$(git diff --staged --name-only --diff-filter=ACMRT)
python=$(git diff --staged --name-only --diff-filter=ACMRT -- '*.py')


# Copy the staged tree to a temporary location. In case of a partial commit, we
# want to run tests on the staged files, not the working tree.
d=$(mktemp -dp /autofs/vast/scratch)
trap "rm -rf -- '$d'" EXIT
git checkout-index --prefix="$d/" -a
cd "$d"


# Spell-check staged files.
echo "Running spell checker"
env typos $staged


# Lint staged Python files.
echo "Running linter"
env ruff check -q $python


# Run all tests.
echo "Running test suite"
env pytest -q
