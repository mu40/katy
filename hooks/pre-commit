#!/bin/sh -e

# Run the spell checker, linter, and unit tests on every commit. The working
# directory of this script will be the top level of the Git repository.


# Temporary storage.
d=$(mktemp -d "/tmp/$(basename "$0").XXXXXX")
trap "rm -rf -- '$d'" EXIT
trap exit INT TERM


# Identify relevant files.
staged="$d/staged"
python="$d/python"
git diff -z --staged --name-only --diff-filter=ACMRT           >"$staged"
git diff -z --staged --name-only --diff-filter=ACMRT -- '*.py' >"$python"


# Copy the staged tree. In case of a partial commit, we want to run tests on
# the staged files, not the working tree.
git checkout-index --prefix="$d/" -a
cd "$d"


# Spell-check staged files.
if [ -s "$staged" ]; then
    echo "Running spell checker"
    xargs -0 typos <"$staged"
fi

# Lint staged Python files.
if [ -s "$python" ]; then
    echo "Running linter"
    xargs -0 ruff check -q <"$python"
fi


# Run unit tests.
echo "Running unit tests"
pytest -q tests/unit
