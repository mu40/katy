#!/bin/sh -e

# Run the spell checker, linter, and test suite on every commit. The working
# directory of this script will be the top level of the Git repository.


# Wrap calls to run checks in container.
sif="$HOME/l/sif/pytorch_2.6.0-cuda12.6-cudnn9-runtime.sif"
env() { app_exec.sh "$sif" "$@" ; }


# Temporary storage.
d=$(mktemp -d "/tmp/$(basename "$0").XXXXXX")
trap "rm -rf -- '$d'" EXIT


# Identify relevant files.
staged="$d/staged"
python="$d/python"
git diff -z --staged --name-only --diff-filter=ACMRT           >"$staged"
git diff -z --staged --name-only --diff-filter=ACMRT -- '*.py' >"$python"


# Copy the staged tree. In case of a partial commit, we want to run tests on
# the staged files, not the working tree.
git checkout-index --prefix="$d/" -a
cd "$d"


# Spell-check staged files.
if [ -s "$staged" ]; then
    echo "Running spell checker"
    env xargs -0 typos <"$staged"
fi

# Lint staged Python files.
if [ -s "$python" ]; then
    echo "Running linter"
    env xargs -0 ruff check -q <"$python"
fi


# Run all tests.
echo "Running test suite"
env pytest -q
